---
title: "TypeORMのエンティティをドメインから取り除きたくて"
description: "個人プロジェクトでTypeORMのエンティティがドメインモデルと同一扱いになってしまっていて、それに対して違和感を覚えていました。そこでその違和感を言語化して、個人的解法を残しておきます。"
category: "typeorm"
tags: ["typeorm", "onion-archtecture", "aggregates"]
thumbnailUrl: "https://github.com/canji53/toLog/tree/master/packages/contents/tolog/posts/remove-typeorm-entity-from-the-daomin/thumbnail.png"
updatedAt: "2021-08-15"
createdAt: "2021-08-15"
---

### はじめに

個人開発しているプロジェクトで TypeORM を採用しているのですが、DB（TypeORM）における[エンティティ](https://typeorm.io/#/entities/what-is-entity)がそのままドメインモデル\*1 になっていて、とにかく違和感がありました。

ベースはレイヤードアーキテクチャに近いものです。

\*1 ここでのドメインモデルは DDD のエンティティと値オブジェクトをひとまとめにして呼称してます。DB におけるエンティティとは別だと認識しています。

ちゃんと設計しろよという話なのですが、その違和感がどうしても頭から離れなかったため、今回はその違和感を言語化（問題として認識する）、ドメインモデルから TypeORM を取り除く方法を自分なりに考えてみました。

あくまでも筆者はこう考えたのね程度に思っていただければです。

### 対象読者

- DDD の初学者（私は超初学者）
- Node.js/TypeScript/RDB でバックエンドを書いている方
- TypeORM を利用している方

### tl; dr

当たり前と言われればそこまでですが、ドメインモデルは一切のライブラリに依存せず他レイヤとも依存しないようにして、TypeORM はインフラストラクチャレイヤに閉じ込めてしまう、が現時点の解法です。

[サンプルコード](https://github.com/canji53/remove-typeorm-entity-from-the-domain)を書いています。
当記事では具体的なコードの説明はしていないため、サンプルからディレクトリ構造や具体的な処理を見て、何をしたいかが多少伝わればと思います :pray:

### 想定している問題点

違和感を言語化すると**以下 3 点の問題が起きている**と考えています。

1. ドメインモデルと言っているが、実体は DB におけるエンティティを指している
2. ドメインモデルが特定の ORM に依存している、微レ存ですが ORM にモデル自体の寿命が握られていると捉えられる
3. ドメインモデルを設計しているようで、実はテーブルを設計していて、本来のビジネスロジックのオブジェクト化からずれている

また、これから**以下の 2 点の問題が起こる**と考えています。

4. インピーダンスミスマッチを回避できず、エンティティが肥大・複雑化してテーブル設計が難しくなる
5. 別の ORM に移行した際に間違いなく大幅な改修が入り、微レ存で同じビジネスロジックを表現できなくなる可能性がある

### どうあるべきと考えているのか？

1. ドメインモデルと DB のエンティティを明確に区別する
2. 適切にインターフェースを利用して、使う側は ORM 自体を知らなくても良い状態にする

### どうするのか？

[オニオンアーキテクチャ](https://qiita.com/cocoa-maemae/items/e3f2eabbe0877c2af8d0#%E3%82%AA%E3%83%8B%E3%82%AA%E3%83%B3%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E3%81%AE%E9%9A%8E%E5%B1%A4%E6%A7%8B%E9%80%A0)を参考にしつつ、ドメインモデルは一切のライブラリに依存せず他レイヤとも依存しないようにして、問題の TypeORM はインフラストラクチャレイヤに閉じ込めてしまいます。

- エンティティとドメインモデルが剥離するのはどうしようもないため、**ドメインモデル側は[集約](https://codezine.jp/article/detail/10776)を使って両者間のデータの受け渡しをできるようにする**
- TypeORM のリポジトリ機能も便利だが、ライブラリへの依存を排除するために、リポジトリのインターフェースを用意する

急にオニオンを引き合いに出しましたが、ドメインをロジックのみに集中できるように依存関係を制御できるアーキテクチャであれば問題ないと考えています。オニオンのレイヤ構造と実際のディレクトリ構造がしっくりきたためです。

### おわりに

インピーダンスミスマッチを解決するための ORM ですが、それすらも抽象化したいと考えると、今回のような問題に直面して、結局二重実装（ドメインモデルと entity を別々で記述、リポジトリのインターフェース化）のようなことに陥ってスピード感が失われそうだなと思いました :sweat_smile:
